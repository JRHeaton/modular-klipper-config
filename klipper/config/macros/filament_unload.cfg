[gcode_macro filament_unload]
description: "Use the extruder to automatically unload filament from the hotend"
gcode:
  {% set push_length = 10 %}
  {% set first_retract_length = 8 %}
  {% set unload_retract_length = params.UNLOAD_LENGTH|default(100) %}
  {% set retract_speed = 45 %}
  {% set push_speed = 4 %}

  SAVE_GCODE_STATE NAME=pre_unload
  M83
  G1 E{push_length} F{4 * 60}
  G1 E-{first_retract_length} F{retract_speed * 60}
  G4 P{5 * 1000}
  G1 E-{unload_retract_length} F{retract_speed * 60}
  RESTORE_GCODE_STATE NAME=pre_unload MOVE=0